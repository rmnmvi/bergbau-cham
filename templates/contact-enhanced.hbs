<!DOCTYPE html>
<html lang="{{#if isFrench}}fr{{else}}en{{/if}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{contact.meta_title}}</title>
    <meta name="description" content="{{contact.meta_description}}">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.edelmetallhandel-cham.de/{{#if isFrench}}fr/{{/if}}contact.html">
    <meta property="og:title" content="{{contact.meta_title}}">
    <meta property="og:description" content="{{contact.meta_description}}">
    <meta property="og:image" content="https://www.edelmetallhandel-cham.de/assets/images/og/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.edelmetallhandel-cham.de/{{#if isFrench}}fr/{{/if}}contact.html">
    <meta property="twitter:title" content="{{contact.meta_title}}">
    <meta property="twitter:description" content="{{contact.meta_description}}">
    <meta property="twitter:image" content="https://www.edelmetallhandel-cham.de/assets/images/og/og-image.jpg">
    
    <link href="/styles.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap');
        .font-sans-body { font-family: 'Open Sans', sans-serif; }
        .btn-primary {
            background-color: #D4AF37;
            color: #111827;
            padding: 16px 32px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            display: inline-block;
            text-align: center;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #B8941F;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Captcha styles */
        .captcha-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        .captcha-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .captcha-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .captcha-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #D4AF37;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .captcha-success {
            color: #16a34a;
        }
        .captcha-error {
            color: #dc2626;
            font-size: 14px;
            margin-top: 8px;
        }
        /* Honeypot - hidden from users */
        .website-field {
            position: absolute;
            left: -9999px;
            top: -9999px;
            height: 0;
            width: 0;
            z-index: -1;
        }
        /* GDPR notice styles */
        .gdpr-notice {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #4b5563;
        }
        .gdpr-notice strong {
            color: #111827;
        }
        .gdpr-notice a {
            color: #D4AF37;
            text-decoration: underline;
        }
        .gdpr-notice a:hover {
            color: #B8941F;
        }
        /* GPS warning styles */
        .gps-warning {
            margin-top: 8px;
            padding: 12px;
            background-color: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body class="font-sans-body">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo/Company Name -->
                <div class="flex items-center">
                    <a href="/{{langPath}}" class="flex items-center">
                        <img src="{{rootPath}}assets/images/logo/logo_black.svg" alt="Edelmetall Cham Logo" class="h-10 w-auto">
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/{{langPath}}contact.html" class="text-gold font-semibold">{{nav.contact}}</a>
                    <a href="/{{langPath}}quote.html" class="bg-gold text-gray-900 px-4 py-2 rounded-md font-semibold hover:bg-gold-light transition">{{nav.quote}}</a>

                    <!-- Language Switcher -->
                    <div class="flex items-center border-l pl-6 ml-6">
                        {{#if isFrench}}
                        <a href="/contact.html" class="text-gray-700 hover:text-gold transition flex items-center">
                            <span class="mr-1">🇬🇧</span> EN
                        </a>
                        {{else}}
                        <a href="/fr/contact.html" class="text-gray-700 hover:text-gold transition flex items-center">
                            <span class="mr-1">🇫🇷</span> FR
                        </a>
                        {{/if}}
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden md:hidden">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <a href="/{{langPath}}contact.html" class="block px-3 py-2 text-gold font-semibold">{{nav.contact}}</a>
                    <a href="/{{langPath}}quote.html" class="block px-3 py-2 bg-gold text-gray-900 rounded-md font-semibold">{{nav.quote}}</a>
                    <div class="border-t mt-3 pt-3">
                        {{#if isFrench}}
                        <a href="/contact.html" class="block px-3 py-2 text-gray-700 hover:text-gold">
                            <span class="mr-1">🇬🇧</span> English
                        </a>
                        {{else}}
                        <a href="/fr/contact.html" class="block px-3 py-2 text-gray-700 hover:text-gold">
                            <span class="mr-1">🇫🇷</span> Français
                        </a>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contact Section -->
    <section class="py-20 bg-white">
        <div class="container mx-auto px-6">
            <h1 class="font-sans-body text-4xl md:text-5xl font-bold text-center mb-4">
                {{contact.title}}
            </h1>
            <p class="text-center text-gray-600 mb-12 max-w-3xl mx-auto">
                {{#if isFrench}}
                Utilisez ce formulaire sécurisé pour contacter nos experts en métaux précieux. Toutes les demandes sont traitées avec la plus grande confidentialité et professionnalisme. Nous répondons à chaque message dans les 24 à 48 heures ouvrées.
                {{else}}
                Use this secure form to contact our precious metals experts. All inquiries are handled with utmost confidentiality and professionalism. We respond to every message within 24-48 business hours.
                {{/if}}
            </p>
            <div class="max-w-2xl mx-auto">
                <form id="contactForm" class="space-y-6" action="/api/submit-contact-enhanced" method="POST">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">{{contact.form.name}} {{contact.form.required}}</label>
                        <input type="text" name="name" id="name" required
                               placeholder="{{contact.form.name_placeholder}}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">{{contact.form.email}} {{contact.form.required}}</label>
                        <input type="email" name="email" id="email" required
                               placeholder="{{contact.form.email_placeholder}}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">{{contact.form.phone}} {{contact.form.required}}</label>
                        <input type="tel" name="phone" id="phone" required
                               placeholder="{{contact.form.phone_placeholder}}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                    </div>
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 mb-2">{{contact.form.message}} {{contact.form.required}}</label>
                        <textarea name="message" id="message" rows="5" required
                                  placeholder="{{contact.form.message_placeholder}}"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent"></textarea>
                    </div>
                    
                    <!-- Country Selector -->
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                            {{#if isFrench}}Pays{{else}}Country{{/if}} {{contact.form.required}}
                        </label>
                        <select name="country" id="country" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                            <option value="">{{#if isFrench}}Sélectionner un pays{{else}}Select a country{{/if}}</option>
                            <option value="Germany">{{#if isFrench}}Allemagne{{else}}Germany{{/if}}</option>
                            <option value="France">France</option>
                            <option value="Switzerland">{{#if isFrench}}Suisse{{else}}Switzerland{{/if}}</option>
                            <option value="Austria">{{#if isFrench}}Autriche{{else}}Austria{{/if}}</option>
                            <option value="Belgium">{{#if isFrench}}Belgique{{else}}Belgium{{/if}}</option>
                            <option value="Netherlands">{{#if isFrench}}Pays-Bas{{else}}Netherlands{{/if}}</option>
                            <option value="Luxembourg">Luxembourg</option>
                            <option value="Italy">{{#if isFrench}}Italie{{else}}Italy{{/if}}</option>
                            <option value="Spain">{{#if isFrench}}Espagne{{else}}Spain{{/if}}</option>
                            <option value="United Kingdom">{{#if isFrench}}Royaume-Uni{{else}}United Kingdom{{/if}}</option>
                            <option value="Other">{{#if isFrench}}Autre{{else}}Other{{/if}}</option>
                        </select>
                    </div>
                    
                    <!-- File Attachment -->
                    <div>
                        <label for="attachment" class="block text-sm font-medium text-gray-700 mb-2">
                            {{#if isFrench}}Pièce jointe (Optionnelle){{else}}Attachment (Optional){{/if}}
                        </label>
                        <input type="file" name="attachment" id="attachment" 
                               accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                        <p class="mt-1 text-sm text-gray-500">
                            {{#if isFrench}}
                            Formats acceptés : PDF, JPG, PNG, GIF, DOC, DOCX, XLS, XLSX, TXT (Max 5MB)
                            {{else}}
                            Accepted formats: PDF, JPG, PNG, GIF, DOC, DOCX, XLS, XLSX, TXT (Max 5MB)
                            {{/if}}
                        </p>
                    </div>
                    
                    <!-- Captcha -->
                    <div class="captcha-container">
                        <div class="captcha-checkbox">
                            <input type="checkbox" id="captcha" name="captcha">
                            <label for="captcha" style="cursor: pointer; user-select: none;">
                                <span id="captchaIcon">
                                    <span id="iconDefault">☐</span>
                                    <span id="iconSpinner" style="display: none;">
                                        <span class="captcha-spinner"></span>
                                    </span>
                                    <span id="iconSuccess" style="display: none;" class="captcha-success">✓</span>
                                    <span id="iconFailure" style="display: none;">✗</span>
                                </span>
                                {{#if isFrench}}
                                Je ne suis pas un robot
                                {{else}}
                                I'm not a robot
                                {{/if}}
                            </label>
                        </div>
                        <div id="captchaError" class="captcha-error" style="display: none;"></div>
                    </div>
                    
                    <!-- Honeypot field (hidden) -->
                    <div class="website-field">
                        <label for="website">Website</label>
                        <input type="text" name="website" id="website" tabindex="-1" autocomplete="off">
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        {{contact.form.submit}}
                    </button>
                </form>
                
                <!-- GDPR Notice -->
                <div class="gdpr-notice">
                    <strong>{{#if isFrench}}Avis de protection des données :{{else}}Data Protection Notice:{{/if}}</strong>
                    {{#if isFrench}}
                    En soumettant ce formulaire, vous acceptez le traitement de vos données personnelles conformément à notre <a href="/fr/privacy.html">Politique de confidentialité</a>. Vos données seront utilisées uniquement pour répondre à votre demande et ne seront pas partagées avec des tiers sans votre consentement. Nous mettons en œuvre des mesures techniques et organisationnelles appropriées pour protéger vos informations personnelles. Vous avez le droit d'accéder, de corriger ou de supprimer vos données à tout moment.
                    {{else}}
                    By submitting this form, you agree to the processing of your personal data in accordance with our <a href="/privacy.html">Privacy Policy</a>. Your data will be used solely to respond to your request and will not be shared with third parties without your consent. We implement appropriate technical and organizational measures to protect your personal information. You have the right to access, correct, or delete your data at any time.
                    {{/if}}
                </div>

                <div class="mt-12 text-center text-gray-700">
                    <p class="font-semibold text-lg mb-2">{{contact.info.company}}</p>
                    <p class="text-sm mb-1">{{contact.info.represented_by}}</p>
                    <p>{{contact.info.address_line1}}</p>
                    <p>{{contact.info.address_line2}}</p>
                    <p class="mt-3">{{contact.info.phone_label}} <a href="tel:{{contact.info.phone}}" class="text-gold hover:underline">{{contact.info.phone}}</a></p>
                    <p>{{contact.info.email_label}} <a href="mailto:{{contact.info.email}}" class="text-gold hover:underline">{{contact.info.email}}</a></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black">
        <div class="mx-auto max-w-7xl overflow-hidden px-6 py-20 sm:py-24 lg:px-8">
            <!-- Navigation Links -->
            <nav aria-label="Footer" class="-mb-6 flex flex-wrap justify-center gap-x-12 gap-y-3 text-sm">
                <a href="/{{langPath}}contact.html" class="text-gray-400 hover:text-gold transition">{{nav.contact}}</a>
                <a href="/{{langPath}}imprint.html" class="text-gray-400 hover:text-gold transition">{{nav.imprint}}</a>
                <a href="/{{langPath}}privacy.html" class="text-gray-400 hover:text-gold transition">{{nav.privacy}}</a>
            </nav>

            <!-- Contact Icons -->
            <div class="mt-16 flex justify-center gap-x-10">
                <!-- Email -->
                <a href="mailto:{{contact.info.email}}" class="text-gray-400 hover:text-gold transition">
                    <span class="sr-only">Email</span>
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </a>

                <!-- Phone -->
                <a href="tel:{{contact.info.phone}}" class="text-gray-400 hover:text-gold transition">
                    <span class="sr-only">Phone</span>
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                </a>
            </div>

            <!-- Copyright & Address -->
            <div class="mt-10 text-center text-sm text-gray-400">
                <p class="mb-2">{{footer.copyright}}</p>
                <p>{{footer.address}}</p>
                <p class="mt-2">
                    <a href="tel:{{contact.info.phone}}" class="hover:text-gold transition">{{contact.info.phone}}</a> ·
                    <a href="mailto:{{contact.info.email}}" class="hover:text-gold transition">{{contact.info.email}}</a>
                </p>
            </div>
        </div>
    </footer>

    <!-- Load FingerprintJS -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.13.0/dist/exif-reader.min.js"></script>
    
    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Initialize fingerprinting and form handling
        let fingerprintId = null;
        let captchaVerified = false;
        let geoLocation = null;
        let fileMetadata = null;
        const formLoadTime = Date.now();
        
        // Initialize FingerprintJS
        const fpPromise = FingerprintJS.load();
        fpPromise
            .then(fp => fp.get())
            .then(result => {
                fingerprintId = result.visitorId;
            })
            .catch(error => console.error('Fingerprinting failed:', error));
        
        // Function to extract EXIF metadata from image files
        async function extractImageMetadata(file) {
            try {
                const tags = await ExifReader.load(file);
                const metadata = {};
                
                // Extract GPS data if available
                if (tags['GPSLatitude'] && tags['GPSLongitude']) {
                    const lat = tags['GPSLatitude'].description;
                    const lon = tags['GPSLongitude'].description;
                    metadata.gps = {
                        latitude: lat,
                        longitude: lon,
                        latitudeRef: tags['GPSLatitudeRef']?.description,
                        longitudeRef: tags['GPSLongitudeRef']?.description,
                        altitude: tags['GPSAltitude']?.description,
                        timestamp: tags['GPSTimeStamp']?.description || tags['GPSDateStamp']?.description
                    };
                    
                    // Show warning about GPS data
                    const attachmentDiv = document.querySelector('input[type="file"]').parentElement;
                    const existingWarning = attachmentDiv.querySelector('.gps-warning');
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                    const warning = document.createElement('div');
                    warning.className = 'gps-warning';
                    const isFrench = document.documentElement.lang === 'fr';
                    warning.innerHTML = `
                        <strong>⚠️ ${isFrench ? 'Données de localisation détectées' : 'Location Data Detected'}:</strong> 
                        ${isFrench ? 'Cette image contient des coordonnées GPS' : 'This image contains GPS coordinates'} 
                        (${lat}, ${lon}). 
                        ${isFrench ? 'Ces informations seront incluses à des fins de vérification.' : 'This information will be included for verification purposes.'}
                    `;
                    attachmentDiv.appendChild(warning);
                }
                
                // Extract camera information
                if (tags['Make'] || tags['Model']) {
                    metadata.camera = {
                        make: tags['Make']?.description,
                        model: tags['Model']?.description,
                        lens: tags['LensModel']?.description
                    };
                }
                
                // Extract image settings
                metadata.settings = {
                    dateTime: tags['DateTime']?.description || tags['DateTimeOriginal']?.description,
                    software: tags['Software']?.description,
                    orientation: tags['Orientation']?.description,
                    xResolution: tags['XResolution']?.description,
                    yResolution: tags['YResolution']?.description
                };
                
                // Extract exposure data
                if (tags['ExposureTime'] || tags['FNumber']) {
                    metadata.exposure = {
                        time: tags['ExposureTime']?.description,
                        fStop: tags['FNumber']?.description,
                        iso: tags['ISOSpeedRatings']?.description,
                        focalLength: tags['FocalLength']?.description,
                        flash: tags['Flash']?.description
                    };
                }
                
                return metadata;
            } catch (error) {
                console.log('Could not extract EXIF metadata:', error);
                return null;
            }
        }
        
        // Captcha handling
        const captchaCheckbox = document.getElementById('captcha');
        const captchaContainer = document.querySelector('.captcha-container');
        const captchaError = document.getElementById('captchaError');
        const captchaIcon = document.getElementById('captchaIcon');
        const iconDefault = document.getElementById('iconDefault');
        const iconSpinner = document.getElementById('iconSpinner');
        const iconSuccess = document.getElementById('iconSuccess');
        const iconFailure = document.getElementById('iconFailure');
        
        if (captchaCheckbox) {
            let isVerifying = false;
            
            captchaCheckbox.addEventListener('change', function(e) {
                if (isVerifying || captchaVerified) {
                    e.preventDefault();
                    return;
                }
                
                if (this.checked) {
                    isVerifying = true;
                    iconDefault.style.display = 'none';
                    iconSpinner.style.display = 'inline-block';
                    captchaError.style.display = 'none';
                    
                    // Rotate the icon
                    captchaIcon.style.transition = 'transform 0.3s';
                    captchaIcon.style.transform = 'rotate(360deg)';
                    
                    // Request geolocation as verification
                    if (navigator.geolocation) {
                        let retryCount = 0;
                        const maxRetries = 2;
                        
                        function attemptGeolocation() {
                            navigator.geolocation.getCurrentPosition(
                                function(position) {
                                    // Success
                                    geoLocation = {
                                        latitude: position.coords.latitude,
                                        longitude: position.coords.longitude,
                                        accuracy: position.coords.accuracy,
                                        timestamp: new Date(position.timestamp).toISOString()
                                    };
                                    
                                    setTimeout(() => {
                                        captchaIcon.style.transform = 'rotate(0deg)';
                                        iconSpinner.style.display = 'none';
                                        iconSuccess.style.display = 'inline-block';
                                        captchaVerified = true;
                                        isVerifying = false;
                                        captchaCheckbox.disabled = true;
                                    }, 500);
                                },
                                function(error) {
                                    // Error or denial
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        setTimeout(attemptGeolocation, 1000);
                                    } else {
                                        // Still verify after retries
                                        setTimeout(() => {
                                            captchaIcon.style.transform = 'rotate(0deg)';
                                            iconSpinner.style.display = 'none';
                                            iconSuccess.style.display = 'inline-block';
                                            captchaVerified = true;
                                            isVerifying = false;
                                            captchaCheckbox.disabled = true;
                                        }, 500);
                                    }
                                },
                                {
                                    enableHighAccuracy: retryCount > 0,
                                    timeout: 10000 + (retryCount * 5000),
                                    maximumAge: 0
                                }
                            );
                        }
                        
                        attemptGeolocation();
                    } else {
                        // No geolocation support - still verify
                        setTimeout(() => {
                            captchaIcon.style.transform = 'rotate(0deg)';
                            iconSpinner.style.display = 'none';
                            iconSuccess.style.display = 'inline-block';
                            captchaVerified = true;
                            isVerifying = false;
                            captchaCheckbox.disabled = true;
                        }, 1500);
                    }
                } else {
                    captchaCheckbox.checked = true;
                }
            });
        }
        
        // File input change listener for metadata extraction
        const attachmentInput = document.getElementById('attachment');
        if (attachmentInput) {
            attachmentInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    fileMetadata = await extractImageMetadata(file);
                    if (fileMetadata) {
                        console.log('Metadata extracted:', fileMetadata);
                    }
                } else {
                    // Clear any existing warnings
                    const attachmentDiv = e.target.parentElement;
                    const existingWarning = attachmentDiv.querySelector('.gps-warning');
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                    fileMetadata = null;
                }
            });
        }

        // Contact form handling
        const contactForm = document.getElementById('contactForm');
        if (contactForm) {
            contactForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const submitButton = this.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                const isFrench = document.documentElement.lang === 'fr';

                // Check if captcha is verified
                if (!captchaVerified) {
                    captchaError.textContent = isFrench ? 
                        'Veuillez compléter la vérification en cliquant sur la case captcha ci-dessus.' :
                        'Please complete the verification by clicking the captcha checkbox above.';
                    captchaError.style.display = 'block';
                    captchaContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                // Show loading state
                submitButton.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-900 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ${isFrench ? 'Envoi en cours...' : 'Submitting...'}
                `;
                submitButton.disabled = true;

                try {
                    // Calculate time to submit
                    const timeToSubmit = Math.floor((Date.now() - formLoadTime) / 1000);
                    
                    // Get form data
                    const formData = new FormData(this);
                    const contactData = {
                        name: formData.get('name'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        message: formData.get('message'),
                        country: formData.get('country'),
                        lang: isFrench ? 'fr' : 'en',
                        // Behavioral data
                        timeToSubmit: timeToSubmit,
                        honeypot: formData.get('website'), // Honeypot field
                        fingerprintId: fingerprintId,
                        formLoadTime: new Date(formLoadTime).toISOString(),
                        // Geolocation data
                        geoLocation: geoLocation,
                        // File metadata
                        fileMetadata: fileMetadata
                    };

                    // Function to send form data
                    const sendFormData = async (data) => {
                        try {
                            // Add timeout for mobile devices
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                            
                            const response = await fetch('/api/submit-contact-enhanced', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(data),
                                signal: controller.signal
                            });
                            
                            clearTimeout(timeoutId);

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();
                            
                            if (result.success) {
                                // Get the section that contains everything
                                const section = document.querySelector('section.py-20.bg-white');
                                if (!section) {
                                    alert((isFrench ? 'Message envoyé avec succès! ID de référence: ' : 'Message sent successfully! Reference ID: ') + result.submissionId);
                                    window.location.reload();
                                    return;
                                }
                                
                                // Replace entire section content with success message
                                section.innerHTML = `
                                    <div class="container mx-auto px-6">
                                        <div style="text-align: center; padding: 60px 20px; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background-color: #dcfce7; border-radius: 50%; margin-bottom: 30px;">
                                                <svg style="width: 40px; height: 40px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <h2 style="font-size: 36px; font-weight: bold; color: #111827; margin-bottom: 16px; font-family: 'Open Sans', sans-serif;">
                                                ${isFrench ? 'Message envoyé avec succès!' : 'Message Sent Successfully!'}
                                            </h2>
                                            <p style="font-size: 18px; color: #4b5563; margin-bottom: 32px; max-width: 500px; line-height: 1.6;">
                                                ${isFrench ? 
                                                    'Merci de nous avoir contactés. Nous avons reçu votre message et vous répondrons dans les 24 à 48 heures.' :
                                                    'Thank you for contacting us. We have received your message and will get back to you within 24-48 hours.'
                                                }
                                            </p>
                                            <p style="font-size: 14px; color: #6b7280; margin-bottom: 32px;">
                                                ${isFrench ? 'ID de référence' : 'Reference ID'}: <strong>${result.submissionId}</strong>
                                            </p>
                                            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                                                <button onclick="window.location.href='/${isFrench ? 'fr' : ''}'" style="display: inline-block; background-color: transparent; color: #111827; padding: 16px 32px; border-radius: 8px; font-weight: 600; text-decoration: none; font-size: 16px; transition: all 0.2s; border: 2px solid #d4af37; cursor: pointer;">
                                                    ${isFrench ? 'Retour à l\'accueil' : 'Go Back to Home'}
                                                </button>
                                                <button onclick="window.location.reload()" style="display: inline-block; background-color: #d4af37; color: #111827; padding: 16px 32px; border-radius: 8px; font-weight: 600; text-decoration: none; font-size: 16px; transition: background-color 0.2s; border: none; cursor: pointer;">
                                                    ${isFrench ? 'Envoyer un autre message' : 'Send Another Message'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                // Scroll to top to show success message
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            } else {
                                // Show error message
                                alert(result.message || (isFrench ? 'Une erreur est survenue. Veuillez réessayer.' : 'An error occurred. Please try again.'));
                                submitButton.innerHTML = originalButtonText;
                                submitButton.disabled = false;
                            }
                        } catch (error) {
                            console.error('Error in sendFormData:', error);
                            if (error.name === 'AbortError') {
                                alert(isFrench ? 
                                    'La soumission a pris trop de temps. Veuillez vérifier votre connexion et réessayer.' :
                                    'Submission timed out. Please check your connection and try again.');
                            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                                alert(isFrench ? 
                                    'Erreur de connexion. Veuillez vérifier votre connexion internet et réessayer.' :
                                    'Connection error. Please check your internet connection and try again.');
                            } else {
                                alert(isFrench ? 
                                    'Impossible de soumettre le formulaire. Veuillez vérifier votre connexion et réessayer.' :
                                    'Failed to submit form. Please check your connection and try again.');
                            }
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                        }
                    };

                    // Handle file attachment if present
                    const fileInput = document.getElementById('attachment');
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        
                        // Check file size (5MB max)
                        if (file.size > 5 * 1024 * 1024) {
                            alert(isFrench ? 
                                'Le fichier est trop volumineux. Taille maximale : 5MB' :
                                'File is too large. Maximum size: 5MB');
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            return;
                        }
                        
                        // Convert file to base64
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            contactData.attachment = {
                                filename: file.name,
                                filetype: file.type,
                                data: e.target.result.split(',')[1] // Remove data:type;base64, prefix
                            };
                            
                            // Add metadata if available
                            if (fileMetadata) {
                                contactData.fileMetadata = fileMetadata;
                            }
                            
                            // Send the form with attachment
                            await sendFormData(contactData);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Send form without attachment
                        await sendFormData(contactData);
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert(isFrench ? 
                        'Impossible de soumettre le formulaire. Veuillez vérifier votre connexion et réessayer.' :
                        'Failed to submit form. Please check your connection and try again.');
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });
        }
    </script>
</body>
</html>